<?xml version="1.0" encoding="utf-8" ?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tourmade.crm.mapper.statistics.StatisticsMapper">

	 <select id="queryAgencyOrderStatus" parameterType="Map" resultType="AgencyOrderStatus">
		select 
			agency_name as agencyName,
			agency_id,
			count(1) as total,
			sum(case when status=0 then 1 else 0 end) as status0 ,
			sum(case when status=1 then 1 else 0 end) as status1,
			sum(case when status=2 then 1 else 0 end) as status2 ,
			sum(case when status=3 then 1 else 0 end) as status3 ,
			sum(case when status=4 then 1 else 0 end) as status4 ,
			concat ( left (sum(case when status=2 then 1 else 0 end) / count(1) *100,5),'%') as rate,
			sum(rmb_price) as dealmoney
		from tm_order
		where isdel = 0
        <if test="searchStartTime != null and searchStartTime != ''">
			and creat_time >= '${searchStartTime}'
		</if> 
		<if test="searchEndTime != null and searchEndTime != ''">
			and creat_time &lt;= '${searchEndTime}'
		</if>
		<if test="destination != null and destination != ''">
        	and destination = #{destination}
        </if>
		group by agency_id
	</select>
	
	<select id="queryCaseSourceStats" parameterType="Map" resultType="CaseSourceStats">
		select 
			c.source as hah,
			p.chinese sourceName,
			count(1) as total,
			sum(case when o.status=0 then 1 else 0 end) as status0 ,
			sum(case when o.status=1 then 1 else 0 end) as status1,
			sum(case when o.status=2 then 1 else 0 end) as status2 ,
			sum(case when o.status=3 then 1 else 0 end) as status3 ,
			sum(case when o.status=4 then 1 else 0 end) as status4 ,
			sum(case when o.status=5 then 1 else 0 end) as status5 ,
			sum(case when o.status=6 then 1 else 0 end) as status6 ,
			concat (left (sum(case when o.status=3 then 1 else 0 end) / count(1) *100,5),'%') as rate,
			sum(o.rmb_price) as dealMoney
		from tm_case c left join tm_order o on c.case_id = o.case_id left join tm_parameter p on c.source=p.para_value
		where c.isdel = 0 
        <if test="searchStartTime != null and searchStartTime != ''">
			and c.creat_time >= '${searchStartTime}'
		</if> 
		<if test="searchEndTime != null and searchEndTime != ''">
			and c.creat_time &lt;= '${searchEndTime}'
		</if>
		group by c.source
	</select>
	
	<select id="queryCaseAllotStats" parameterType="Map" resultType="CaseAllotStats">
		select 
			u.user_name as userName,
			u.user_id,
			count(1) as total,
			sum(case when c.source='web_form' then 1 else 0 end) as web_form ,
			sum(case when c.source='mobile_form' then 1 else 0 end) as mobile_form,
			sum(case when c.source='direct_form' then 1 else 0 end) as direct_form ,
			sum(case when c.source='wechat_form' then 1 else 0 end) as wechat_form ,
			sum(case when c.source='web_service' then 1 else 0 end) as web_service ,
			sum(case when c.source='mobile_service' then 1 else 0 end) as mobile_service ,
			sum(case when c.source='phone_service' then 1 else 0 end) as phone_service ,
			sum(case when c.source='wechat_service' then 1 else 0 end) as wechat_service ,
			sum(case when c.source='offline' then 1 else 0 end) as offline ,
			sum(case when c.source='email' then 1 else 0 end) as email ,
			sum(case when c.source='friends' then 1 else 0 end) as friends ,
			sum(case when c.source='customer' then 1 else 0 end) as customer ,
			sum(case when c.source='ctrip' then 1 else 0 end) as ctrip
		from tm_user u left join tm_case c on u.user_id=c.operator 
		where c.isdel = 0 
        <if test="searchStartTime != null and searchStartTime != ''">
			and c.creat_time >= '${searchStartTime}'
		</if> 
		<if test="searchEndTime != null and searchEndTime != ''">
			and c.creat_time &lt;= '${searchEndTime}'
		</if>
		group by u.user_id
	</select>
	
	<select id="queryAgencyAchievementStats" parameterType="Map" resultType="AgencyAchievementStats">
		select 
			o.agency_id,
			o.agency_name as agencyName,
			concat(format(sum(if(month(o.creat_time) = 1 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 1 ,1,0))*100,2),'%') as percentjan,
			concat(format(sum(if(month(o.creat_time) = 2 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 2 ,1,0))*100,2),'%') as percentfeb,
			concat(format(sum(if(month(o.creat_time) = 3 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 3 ,1,0))*100,2),'%') as percentmar,
			concat(format(sum(if(month(o.creat_time) = 4 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 4 ,1,0))*100,2),'%') as percentapr,
			concat(format(sum(if(month(o.creat_time) = 5 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 5 ,1,0))*100,2),'%') as percentmay,
			concat(format(sum(if(month(o.creat_time) = 6 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 6 ,1,0))*100,2),'%') as percentjun,
			concat(format(sum(if(month(o.creat_time) = 7 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 7 ,1,0))*100,2),'%') as percentjul,
			concat(format(sum(if(month(o.creat_time) = 8 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 8 ,1,0))*100,2),'%') as percentaug,
			concat(format(sum(if(month(o.creat_time) = 9 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 9 ,1,0))*100,2),'%') as percentsep,
			concat(format(sum(if(month(o.creat_time) = 10 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 10 ,1,0))*100,2),'%') as percentoct,
			concat(format(sum(if(month(o.creat_time) = 11 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 11 ,1,0))*100,2),'%') as percentnov,
			concat(format(sum(if(month(o.creat_time) = 12 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 12 ,1,0))*100,2),'%') as percentdece     
			from tm_order o
			where o.isdel = 0
        <if test="searchStartTime != null and searchStartTime != ''">
			and o.creat_time >= '${searchStartTime}'
		</if> 
		<if test="searchEndTime != null and searchEndTime != ''">
			and o.creat_time &lt;= '${searchEndTime}'
		</if>
		group by o.agency_id 
	</select>
	
	<select id="queryAgencyAchievementStatsM" parameterType="Map" resultType="AgencyAchievementStatsM">
		select 
			o.agency_name as agencyname,
			o.agency_id,
			sum(if(month(o.group_time) = 1 ,o.rmb_price,0)) as percentjan,
			sum(if(month(o.group_time) = 2 ,o.rmb_price,0)) as percentfeb,
			sum(if(month(o.group_time) = 3 ,o.rmb_price,0)) as percentmar,
			sum(if(month(o.group_time) = 4 ,o.rmb_price,0)) as percentapr,
			sum(if(month(o.group_time) = 5 ,o.rmb_price,0)) as percentmay,
			sum(if(month(o.group_time) = 6 ,o.rmb_price,0)) as percentjun,
			sum(if(month(o.group_time) = 7 ,o.rmb_price,0)) as percentjul,
			sum(if(month(o.group_time) = 8 ,o.rmb_price,0)) as percentaug,
			sum(if(month(o.group_time) = 9 ,o.rmb_price,0)) as percentsep,
			sum(if(month(o.group_time) = 10 ,o.rmb_price,0)) as percentoct,
			sum(if(month(o.group_time) = 11 ,o.rmb_price,0)) as percentnov,
			sum(if(month(o.group_time) = 12 ,o.rmb_price,0)) as percentdece
		from tm_order o
		where o.isdel = 0 and o.`status` = '2'
        <if test="searchStartTime != null and searchStartTime != ''">
			and o.group_time >= '${searchStartTime}'
		</if> 
		<if test="searchEndTime != null and searchEndTime != ''">
			and o.group_time &lt;= '${searchEndTime}'
		</if>
		group by o.agency_id
	</select>
	
	<select id="querySellerCoverStats" parameterType="Map" resultType="SellerCoverStats">
		select 
			a.country coun,
			p.chinese country,
			count(a.agency_id) number
		from tm_agency a left join tm_parameter p on a.country = p.para_value
		group by a.country 
		order by count(a.agency_id) desc  
	</select>
	
	<select id="querySellerNotAskStats" parameterType="Map" resultType="SellerNotAskStats">
		select 
			a.country country_en,
			p.chinese country,
			count(a.agency_id) number
		from tm_agency a left join tm_parameter p on a.country = p.para_value
		WHERE country not in (
			select 
				destination AS country 
				from tm_case 
				WHERE destination IS NOT NULL
				<if test="searchStartTime != null and searchStartTime != ''">
					and creat_time >= '${searchStartTime}'
				</if> 
				<if test="searchEndTime != null and searchEndTime != ''">
					and creat_time &lt;= '${searchEndTime}'
				</if>
				)
		and a.isdel=0
		group by a.country 
		order by count(a.agency_id) desc   
	</select>
	
	<select id="querySellerNotAskStatsD" parameterType="Map" resultType="SellerNotAskStatsD">
		select 
			a.agency_name as destination, 
			a.agency_id,
			a.destination as country
			from tm_agency a 
			WHERE country not in (
				select 
					destination AS country 
					from tm_case 
					WHERE destination IS NOT NULL
					<if test="searchStartTime != null and searchStartTime != ''">
						and creat_time >= '${searchStartTime}'
					</if> 
					<if test="searchEndTime != null and searchEndTime != ''">
						and creat_time &lt;= '${searchEndTime}'
					</if>
			)
			and a.isdel=0
		group by a.agency_id
		ORDER BY count(a.agency_id) desc    
	</select>
	
	<select id="queryCustomerSourceLevelStats" parameterType="Map" resultType="CustomerSourceLevelStats">
		select 
			c.source as source_en,
			p.chinese as source,
			count(1),
				sum(case when c.customer_level=0 then 1 else 0 end) as level0 ,
				sum(case when c.customer_level=1 then 1 else 0 end) as level1,
				sum(case when c.customer_level=2 then 1 else 0 end) as level2 ,
				sum(case when c.customer_level=3 then 1 else 0 end) as level3 ,
				concat ( left (sum(case when c.customer_level=3 then 1 else 0 end) / count(1) *100,4),'%') as rate
		from tm_customer c left join tm_parameter p on c.source = p.para_value
		where c.isdel = 0
		group by c.source    
	</select>
	
	<select id="countCustomerSourceLevelStats" parameterType="CustomerSourceLevelStats" resultType="long">
		select count(source_en) from (
			select 
				c.source as source_en,
				p.chinese as source,
				count(1),
					sum(case when c.customer_level=0 then 1 else 0 end) as level0 ,
					sum(case when c.customer_level=1 then 1 else 0 end) as level1,
					sum(case when c.customer_level=2 then 1 else 0 end) as level2 ,
					sum(case when c.customer_level=3 then 1 else 0 end) as level3 ,
					concat ( left (sum(case when c.customer_level=3 then 1 else 0 end) / count(1) *100,4),'%') as rate
			from tm_customer c left join tm_parameter p on c.source = p.para_value
			where c.isdel = 0
			group by c.source    
		) table_name
	</select>
	
	<select id="countSellerNotAskStatsD" parameterType="SellerNotAskStatsD" resultType="long">
		select count(country) from (
			select 
				a.agency_name as destination, 
				a.agency_id,
				a.destination as country
				from tm_agency a 
				WHERE country not in (
					select 
						destination AS country 
						from tm_case 
						WHERE destination IS NOT NULL
						<if test="searchStartTime != null and searchStartTime != ''">
							and creat_time >= '${searchStartTime}'
						</if> 
						<if test="searchEndTime != null and searchEndTime != ''">
							and creat_time &lt;= '${searchEndTime}'
						</if>
				)
				and a.isdel=0
			group by a.agency_id
			ORDER BY count(a.agency_id) desc    
		) table_name
	</select>
	
	<select id="countSellerCoverStats" parameterType="SellerCoverStats" resultType="long">
		select count(coun) from (
			select 
				a.country coun,
				p.chinese country,
				count(a.agency_id) number
			from tm_agency a left join tm_parameter p on a.country = p.para_value
			group by a.country 
			order by count(a.agency_id) desc  
		) table_name
	</select>
	
	<select id="countSellerNotAskStats" parameterType="SellerNotAskStats" resultType="long">
		select count(country) from (
			select 
				a.country country_en,
				p.chinese country,
				count(a.agency_id) number
			from tm_agency a left join tm_parameter p on a.country = p.para_value
			WHERE country not in (
				select 
					destination AS country 
					from tm_case 
					WHERE destination IS NOT NULL
					<if test="searchStartTime != null and searchStartTime != ''">
						and creat_time >= '${searchStartTime}'
					</if> 
					<if test="searchEndTime != null and searchEndTime != ''">
						and creat_time &lt;= '${searchEndTime}'
					</if>
					)
			and a.isdel=0
			group by a.country 
			order by count(a.agency_id) desc 
		) table_name
	</select>
	
	<select id="countAgencyAchievementStatsM" parameterType="AgencyAchievementStatsM" resultType="long">
		select count(agency_id) from (
			select 
				o.agency_name as agencyname,
				o.agency_id,
				sum(if(month(o.group_time) = 1 ,o.rmb_price,0)) as percentjan,
				sum(if(month(o.group_time) = 2 ,o.rmb_price,0)) as percentfeb,
				sum(if(month(o.group_time) = 3 ,o.rmb_price,0)) as percentmar,
				sum(if(month(o.group_time) = 4 ,o.rmb_price,0)) as percentapr,
				sum(if(month(o.group_time) = 5 ,o.rmb_price,0)) as percentmay,
				sum(if(month(o.group_time) = 6 ,o.rmb_price,0)) as percentjun,
				sum(if(month(o.group_time) = 7 ,o.rmb_price,0)) as percentjul,
				sum(if(month(o.group_time) = 8 ,o.rmb_price,0)) as percentaug,
				sum(if(month(o.group_time) = 9 ,o.rmb_price,0)) as percentsep,
				sum(if(month(o.group_time) = 10 ,o.rmb_price,0)) as percentoct,
				sum(if(month(o.group_time) = 11 ,o.rmb_price,0)) as percentnov,
				sum(if(month(o.group_time) = 12 ,o.rmb_price,0)) as percentdece
			from tm_order o
			where o.isdel = 0 and o.`status` = '2'
	        <if test="searchStartTime != null and searchStartTime != ''">
				and o.group_time >= '${searchStartTime}'
			</if> 
			<if test="searchEndTime != null and searchEndTime != ''">
				and o.group_time &lt;= '${searchEndTime}'
			</if>
			group by o.agency_id
		) table_name
	</select>
	
	<select id="countAgencyAchievementStats" parameterType="AgencyAchievementStats" resultType="long">
		select count(agency_id) from (
			select 
				o.agency_id,
				o.agency_name as agencyName,
				concat(format(sum(if(month(o.creat_time) = 1 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 1 ,1,0))*100,2),'%') as percentjan,
				concat(format(sum(if(month(o.creat_time) = 2 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 2 ,1,0))*100,2),'%') as percentfeb,
				concat(format(sum(if(month(o.creat_time) = 3 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 3 ,1,0))*100,2),'%') as percentmar,
				concat(format(sum(if(month(o.creat_time) = 4 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 4 ,1,0))*100,2),'%') as percentapr,
				concat(format(sum(if(month(o.creat_time) = 5 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 5 ,1,0))*100,2),'%') as percentmay,
				concat(format(sum(if(month(o.creat_time) = 6 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 6 ,1,0))*100,2),'%') as percentjun,
				concat(format(sum(if(month(o.creat_time) = 7 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 7 ,1,0))*100,2),'%') as percentjul,
				concat(format(sum(if(month(o.creat_time) = 8 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 8 ,1,0))*100,2),'%') as percentaug,
				concat(format(sum(if(month(o.creat_time) = 9 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 9 ,1,0))*100,2),'%') as percentsep,
				concat(format(sum(if(month(o.creat_time) = 10 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 10 ,1,0))*100,2),'%') as percentoct,
				concat(format(sum(if(month(o.creat_time) = 11 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 11 ,1,0))*100,2),'%') as percentnov,
				concat(format(sum(if(month(o.creat_time) = 12 &amp;&amp; o.status = '3',1,0))/sum(if(month(o.creat_time) = 12 ,1,0))*100,2),'%') as percentdece     
				from tm_order o
				where o.isdel = 0
	        <if test="searchStartTime != null and searchStartTime != ''">
				and o.creat_time >= '${searchStartTime}'
			</if> 
			<if test="searchEndTime != null and searchEndTime != ''">
				and o.creat_time &lt;= '${searchEndTime}'
			</if>
			group by o.agency_id 
		) table_name
	</select>
	
	<select id="countAgencyOrderStatus" parameterType="AgencyOrderStatus" resultType="long">
		select count(agency_id) from (
			select 
				agency_name as agencyName,
				agency_id,
				count(1) as total,
				sum(case when status=0 then 1 else 0 end) as status0 ,
				sum(case when status=1 then 1 else 0 end) as status1,
				sum(case when status=2 then 1 else 0 end) as status2 ,
				sum(case when status=3 then 1 else 0 end) as status3 ,
				sum(case when status=4 then 1 else 0 end) as status4 ,
				concat ( left (sum(case when status=2 then 1 else 0 end) / count(1) *100,5),'%') as rate,
				sum(rmb_price) as dealmoney
			from tm_order
			where isdel = 0
			<if test="destination != null and destination != ''">
	        	and destination = #{destination}
	        </if>
	        <if test="searchStartTime != null and searchStartTime != ''">
				and creat_time >= '${searchStartTime}'
			</if> 
			<if test="searchEndTime != null and searchEndTime != ''">
				and  creat_time &lt;= '${searchEndTime}'
			</if>
			group by agency_id
		) table_name
	</select>
	
	<select id="countCaseSourceStats" parameterType="CaseSourceStats" resultType="long">
		select count(sourceName) from (
			select 
				c.source as hah,
				p.chinese sourceName,
				count(1) as total,
				sum(case when o.status=0 then 1 else 0 end) as status0 ,
				sum(case when o.status=1 then 1 else 0 end) as status1,
				sum(case when o.status=2 then 1 else 0 end) as status2 ,
				sum(case when o.status=3 then 1 else 0 end) as status3 ,
				sum(case when o.status=4 then 1 else 0 end) as status4 ,
				sum(case when o.status=5 then 1 else 0 end) as status5 ,
				sum(case when o.status=6 then 1 else 0 end) as status6 ,
				concat (left (sum(case when o.status=3 then 1 else 0 end) / count(1) *100,5),'%') as rate,
				sum(o.rmb_price) as dealMoney
			from tm_case c left join tm_order o on c.case_id = o.case_id left join tm_parameter p on c.source=p.para_value
			where c.isdel = 0 
	        <if test="searchStartTime != null and searchStartTime != ''">
				and c.creat_time >= '${searchStartTime}'
			</if> 
			<if test="searchEndTime != null and searchEndTime != ''">
				and c.creat_time &lt;= '${searchEndTime}'
			</if>
			group by c.source
		) temp
	</select>
	
	<select id="countCaseAllotStats" parameterType="CaseAllotStats" resultType="long">
		select count(userName) from(
			select 
				u.user_name as userName,
				u.user_id,
				count(1) as total,
				sum(case when c.source='web_form' then 1 else 0 end) as web_form ,
				sum(case when c.source='mobile_form' then 1 else 0 end) as mobile_form,
				sum(case when c.source='direct_form' then 1 else 0 end) as direct_form ,
				sum(case when c.source='wechat_form' then 1 else 0 end) as wechat_form ,
				sum(case when c.source='web_service' then 1 else 0 end) as web_service ,
				sum(case when c.source='mobile_service' then 1 else 0 end) as mobile_service ,
				sum(case when c.source='phone_service' then 1 else 0 end) as phone_service ,
				sum(case when c.source='wechat_service' then 1 else 0 end) as wechat_service ,
				sum(case when c.source='offline' then 1 else 0 end) as offline ,
				sum(case when c.source='email' then 1 else 0 end) as email ,
				sum(case when c.source='friends' then 1 else 0 end) as friends ,
				sum(case when c.source='customer' then 1 else 0 end) as customer ,
				sum(case when c.source='ctrip' then 1 else 0 end) as ctrip
			from tm_user u left join tm_case c on u.user_id=c.operator 
			where c.isdel = 0 
	        <if test="searchStartTime != null and searchStartTime != ''">
				and c.creat_time >= '${searchStartTime}'
			</if> 
			<if test="searchEndTime != null and searchEndTime != ''">
				and c.creat_time &lt;= '${searchEndTime}'
			</if>
			group by u.user_id
		) temp
	</select>
	
	<select id="getParameterInfo" parameterType="String" resultType="EntityList">
		select
		u.para_domain,
		u.para_value as id,
		u.chinese as text,
		u.isdisplay,
		u.isdel 
		from tm_parameter u where u.isdisplay = 1 and u.isdel = 0 and u.para_domain = #{domain}
	</select>
	
</mapper>