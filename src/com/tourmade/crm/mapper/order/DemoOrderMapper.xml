<?xml version="1.0" encoding="utf-8" ?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tourmade.crm.mapper.order.DemoOrderMapper">

	<select id="queryOrder" parameterType="Map" resultType="DemoOrder">
		SELECT *
		FROM (
		select
		u.order_id as orderid,
		u.customer_id as customerid,
		u.customer_name as customername,
		u.agency_id as agencyid,
		u.agency_name as agencyname,
		u.sales_id as salesid,
		u.sales_name as salesname,
		u.destination as destination,
		u.budget as budget,
		u.status as status,
		u.reason as reason,
		u.group_time as grouptime,
		u.group_number as groupnumber,
		u.start_date as startdate,
		u.end_date as enddate,
		u.group_price as groupprice,
		u.currency as currency,
		u.exchange_rate as exchangerate,
		u.last_response as lastresponse,	
		u.creat_time as creattime,
		u.isdel
		from tm_order u  
		where u.isdel = 0 
		order by u.creat_time desc
		) table_alias
		limit #{b},#{e}
	</select>

	<select id="queryOrderByCaseid" parameterType="Map" resultType="DemoOrder">
		SELECT *
		FROM (
		select
		u.order_id as orderid,
		u.customer_id as customerid,
		u.customer_name as customername,
		u.agency_id as agencyid,
		u.agency_name as agencyname,
		u.sales_id as salesid,
		u.sales_name as salesname,
		u.destination as destination,
		u.budget as budget,
		u.status as status
		from tm_order u  
		where u.isdel = 0 and u.case_id = #{id}
		order by u.creat_time 
		) table_alias
		limit #{b},#{e}
	</select>
	
	<select id="countOrder" parameterType="DemoOrder" resultType="long">
		select count(u.order_id) from tm_order u
		where
		u.isdel = 0
	</select>
	
	<select id="customerstatus">
		update tm_customer set
		customer_level = #{status}
		where
		customer_id = #{id}
	</select>
	
	<select id="validate" parameterType="int" resultType="String">
		select email from tm_customer 
		where customer_id = #{id}
		and isdel = 0
	</select>
	
	<select id="countOrderByCaseid" parameterType="DemoOrder" resultType="long">
		select count(u.order_id) from tm_order u
		where
		u.isdel = 0 and u.case_id = #{id}
	</select>
	
	<select id="getInfo" parameterType="DemoOrder" resultType="DemoOrder">
		select
		a.agency_id as agencyid, 
		a.agency_name as agencyname,
		b.customer_name_zh as customername,
		b.email as customeremailreal,
		c.sales_email as agencyemailreal,
		c.sales_name as salesname
		from tm_sales c 
		left join tm_customer b on b.customer_id = #{customerid}
		left join tm_agency a on a.agency_id = c.agency_id
		where
		a.isdel = 0 and b.isdel = 0 and c.isdel = 0 and c.sales_id = #{salesid}
	</select>
	
	<insert id="saveOrder" parameterType="DemoOrder" flushCache="true" useGeneratedKeys="true" keyProperty="orderid" keyColumn="GENERATED_KEY">
		insert into tm_order(
		case_id,
		customer_id,
		customer_name,
		agency_id,
		agency_name,
		sales_id,
		sales_name,
		customer_email_real,
		customer_email_alias,
		agency_email_real,
		agency_email_alias,
		destination,
		budget,
		status,
		reason,
		group_time,
		group_number,
		start_date,
		end_date,
		group_price,
		currency,
		exchange_rate,
		last_response,
		creat_time,
		isdel
		)values(
		#{caseid,jdbcType=VARCHAR},
		#{customerid,jdbcType=VARCHAR},
		#{customername,jdbcType=VARCHAR},
		#{agencyid},
		#{agencyname},
		#{salesid,jdbcType=VARCHAR},
		#{salesname,jdbcType=VARCHAR},
		#{customeremailreal},
		#{customeremailalias},
		#{agencyemailreal},
		#{agencyemailalias},
		#{destination,jdbcType=VARCHAR},
		#{budget,jdbcType=VARCHAR},
		#{status,jdbcType=VARCHAR},
		#{reason,jdbcType=VARCHAR},
		#{grouptime,jdbcType=VARCHAR},
		#{groupnumber,jdbcType=VARCHAR},
		#{startdate,jdbcType=VARCHAR},
		#{enddate,jdbcType=VARCHAR},
		#{groupprice,jdbcType=VARCHAR},
		#{currency,jdbcType=VARCHAR},
		#{exchangerate,jdbcType=VARCHAR},
		#{lastresponse,jdbcType=VARCHAR},
		NOW(),
		0
		)
	</insert>

	<update id="updateOrder" parameterType="DemoOrder" flushCache="true">
		update tm_order
		set
		customer_name=#{customername},
		agency_id=#{agencyid},
		agency_name=#{agencyname},
		sales_id=#{salesid},
		sales_name=#{salesname},
		customer_email_alias=#{customeremailalias},
		agency_email_alias=#{agencyemailalias},
		destination=#{destination},
		budget=#{budget},
		status=#{status},
		reason=#{reason},
		group_time=#{grouptime},
		group_number=#{groupnumber},
		start_date=#{startdate},
		end_date=#{enddate},
		group_price=#{groupprice},
		rmb_price=#{rmbprice},
		currency=#{currency},
		exchange_rate=#{exchangerate},
		last_response=#{lastresponse},
		update_time=NOW()
		where
		order_id=#{orderid}
	</update>
	
	<select id="getAgencyBySales" parameterType="int" resultType="DemoOrder">
		select
			a.agency_name as agencyname,
			b.agency_id as agencyid,
			b.sale_email as agencyemailreal,
			b.sale_name as salesname
			from tm_agency a 
			left join tm_sale b on b.agency_id = a.agency_id
			where b.sale_id = #{salesid}
	</select>
	
	<select id="getCustomerEmailReal" parameterType="int" resultType="String">
		select
			email as customerEmailReal
			from tm_customer
			where customer_id = #{customerid}
	</select>
	
	<select id="getCustomerById" parameterType="int" resultType="DemoCustomer">
		select
		u.customer_name_zh as zname,
		u.customer_name_en as ename
		from tm_customer u where u.customer_id = #{id}
	</select>	

	<select id="getCaseById" parameterType="int" resultType="DemoCase">
		select
		u.case_id as caseid,
		u.customer_id as customerid, 
		u.operator as operator,
		u.prefer_language as preferlanguage,
		u.contact_type as contacttype,
		u.with_who as withwho,
		u.adult as adult,
		u.children as children,
		u.baby as baby,
		u.start_time as starttime,
		u.start_month as startmonth,
		u.during as during,
		u.start_date as startdate,
		u.end_date as enddate,
		u.requirement as requirement,
		u.route as route,
		u.hotel as hotel,
		u.meals as meals,
		u.guide as guide,
		u.budget as budget,
		u.sales_id as salesid,
		u.destination as destination,
		u.source as source,
		u.promote_code as promotecode,
		u.status as status,
		u.tailormade as tailormade,
		u.passport as passport,
		u.visa as visa,
		u.flight as flight,
		u.ip_address as ipaddress,
		u.creat_time as creattime,
		u.isdel
		from tm_case u where u.isdel = 0 and u.case_id = #{id}
	</select>
		
	<select id="getOrderById" parameterType="int" resultType="DemoOrder">
		select
		u.order_id as orderid,
		u.case_id as caseid,
		u.customer_id as customerid,
		u.customer_name as customername,
		u.agency_id as agencyid,
		u.agency_name as agencyname,
		u.sales_id as salesid,
		u.sales_name as salesname,
		u.destination as destination,
		u.customer_email_real as customeremailreal,
		u.customer_email_alias as customeremailalias,
		u.agency_email_real as agencyemailreal,
		u.agency_email_alias as agencyemailalias,
		u.budget as budget,
		u.status as status,
		u.reason as reason,
		u.group_time as grouptime,
		u.group_number as groupnumber,
		u.start_date as startdate,
		u.end_date as enddate,
		u.group_price as groupprice,
		u.currency as currency,
		u.exchange_rate as exchangerate,
		u.rmb_price as rmbprice,
		u.last_response as lastresponse,	
		u.creat_time as creattime,
		u.isdel as isdel
		from tm_order u where u.order_id = #{orderid}
	</select>
	
	<select id="getParameterInfo" parameterType="String" resultType="DemoList">
		select
		u.para_domain,
		u.para_value as id,
		u.chinese as text,
		u.isdisplay,
		u.isdel 
		from tm_parameter u where u.isdisplay = 1 and u.isdel = 0 and u.para_domain = #{domain}
	</select>
	
	<update id="deleteOrderById" parameterType="int" flushCache="true"
		statementType="PREPARED">
		update tm_order
		set
		isdel=1
		where
		order_id = #{orderid}
	</update>
</mapper>